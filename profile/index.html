<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Profil Pengguna</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; max-width: 500px; margin: 30px auto; }
    input, button, textarea { width: 100%; margin: 10px 0; padding: 8px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>Login Supabase + Lengkapi Profil</h2>
<hr />
<h3>Avatar Saat Ini</h3>
<img id="avatar-preview" src="" alt="Avatar" width="150" />

<hr />
<h3>File Anda</h3>
<table border="1" width="100%">
  <thead>
    <tr>
      <th>Nama File</th>
      <th>Lihat</th>
      <th>Hapus</th>
    </tr>
  </thead>
  <tbody id="file-list"></tbody>
</table>

  <div id="login">
    <button id="google-login">Login dengan Google</button>
  </div>

  <div id="profile" class="hidden">

    <h3>Foto Profil</h3>
<input type="file" id="avatar" />
<button id="upload-avatar">📷 Upload Foto Profil</button>

<h3>File Tambahan</h3>
<input type="file" id="extra-file" />
<button id="upload-extra">📁 Upload File</button>

<button id="save">💾 Simpan Profil</button>
<button id="logout">🚪 Logout</button>
<p id="status"></p>

    
    <p id="user-email"></p>
    <input type="text" id="name" placeholder="Nama lengkap" />
    <textarea id="address" placeholder="Alamat"></textarea>
    <input type="text" id="phone" placeholder="Nomor Telepon" />
    <input type="file" id="avatar" />
    <button id="save">Simpan Profil</button>
    <p id="status"></p>
  </div>

  <script>
const SUPABASE_URL = 'https://zligkbkrxqqbetnwykrq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpsaWdrYmtyeHFxYmV0bnd5a3JxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyNjM2ODUsImV4cCI6MjA2NDgzOTY4NX0.kDK8_c6qCKKRax4HbHwEbAMwTavhDRWdgqkDtjWWYD8';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const loginDiv = document.getElementById('login');
    const profileDiv = document.getElementById('profile');
    const googleBtn = document.getElementById('google-login');
    const userEmail = document.getElementById('user-email');
    const status = document.getElementById('status');

    const uploadAvatarBtn = document.getElementById('upload-avatar');
const uploadExtraBtn = document.getElementById('upload-extra');
const extraFileInput = document.getElementById('extra-file');
const logoutBtn = document.getElementById('logout');

    

    // Cek session login
    supabase.auth.getSession().then(async ({ data: { session } }) => {
      if (session) {
        showProfile(session.user);
      }
    });

    // Login Google
    googleBtn.onclick = async () => {
      await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: location.href
        }
      });
    };

    async function showProfile(user) {
      loginDiv.classList.add('hidden');
      profileDiv.classList.remove('hidden');
      userEmail.textContent = 'Login sebagai: ' + user.email;

      // Muat data profil jika sudah ada
      const { data: existing, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single();

      if (existing) {

  
        
        document.getElementById('name').value = existing.name || '';
        document.getElementById('address').value = existing.address || '';
        document.getElementById('phone').value = existing.phone || '';
     if (existing.avatar_url) {
    updateAvatar(existing.avatar_url);
  }
}

loadFiles(user); // ← ini juga masuk ke sini

      document.getElementById('save').onclick = async () => {
        const name = document.getElementById('name').value;
        const address = document.getElementById('address').value;
        const phone = document.getElementById('phone').value;
        const file = document.getElementById('avatar').files[0];

        let avatar_url = null;

        if (file) {
          const filePath = `${user.id}/${file.name}`;
          const { error: uploadError } = await supabase.storage
            .from('avatars') // <-- nama bucket storage
            .upload(filePath, file, { upsert: true });

          if (uploadError) {
            status.textContent = '❌ Gagal upload file: ' + uploadError.message;
            return;
          }

          const { data: urlData } = supabase.storage
            .from('avatars')
            .getPublicUrl(filePath);
          avatar_url = urlData.publicUrl;
        }

        const { error: saveError } = await supabase
          .from('profiles')
          .upsert({
            id: user.id,
            email: user.email,
            name,
            address,
            phone,
            avatar_url
          });

        status.textContent = saveError
          ? '❌ Gagal simpan: ' + saveError.message
          : '✅ Profil berhasil disimpan';

        updateAvatar(avatar_url);
loadFiles(user);

        
      };
    }

    // Tampilkan avatar
function updateAvatar(url) {
  document.getElementById('avatar-preview').src = url;
}

// Load daftar file dari storage
async function loadFiles(user) {
  const { data: files, error } = await supabase
    .storage
    .from('avatars')
    .list(user.id + '/', { limit: 100 });

  const tbody = document.getElementById('file-list');
  tbody.innerHTML = '';

  if (error) {
    tbody.innerHTML = '<tr><td colspan="3">❌ Gagal memuat file</td></tr>';
    return;
  }

  files.forEach(file => {
    const tr = document.createElement('tr');

    const fileName = document.createElement('td');
    fileName.textContent = file.name;

    const viewLink = document.createElement('td');
    const link = document.createElement('a');
    link.href = supabase.storage
      .from('avatars')
      .getPublicUrl(`${user.id}/${file.name}`).data.publicUrl;
    link.textContent = '🔗 Lihat';
    link.target = '_blank';
    viewLink.appendChild(link);

    const deleteBtn = document.createElement('td');
    const btn = document.createElement('button');
    btn.textContent = '🗑️ Hapus';
    btn.onclick = async () => {
      const { error } = await supabase.storage
        .from('avatars')
        .remove([`${user.id}/${file.name}`]);
      if (!error) {
        loadFiles(user); // refresh
      }
    };
    deleteBtn.appendChild(btn);

    tr.appendChild(fileName);
    tr.appendChild(viewLink);
    tr.appendChild(deleteBtn);
    tbody.appendChild(tr);
  });
}
uploadAvatarBtn.onclick = async () => {
  const file = document.getElementById('avatar').files[0];
  if (!file) {
    status.textContent = '❌ Pilih file foto dulu.';
    return;
  }

  const filePath = `${user.id}/${file.name}`;
  const { error: uploadError } = await supabase.storage
    .from('avatars')
    .upload(filePath, file, { upsert: true });

  if (uploadError) {
    status.textContent = '❌ Gagal upload avatar: ' + uploadError.message;
    return;
  }

  const { data: urlData } = supabase.storage
    .from('avatars')
    .getPublicUrl(filePath);

  const avatar_url = urlData.publicUrl;

  updateAvatar(avatar_url);

  // Update URL avatar di profil
  const { error: saveError } = await supabase
    .from('profiles')
    .upsert({
      id: user.id,
      avatar_url
    });

  status.textContent = saveError
    ? '❌ Gagal update avatar'
    : '✅ Foto profil diperbarui';
};

uploadExtraBtn.onclick = async () => {
  const file = extraFileInput.files[0];
  if (!file) {
    status.textContent = '❌ Pilih file terlebih dahulu.';
    return;
  }

  const filePath = `${user.id}/${file.name}`;
  const { error } = await supabase.storage
    .from('avatars')
    .upload(filePath, file, { upsert: true });

  if (error) {
    status.textContent = '❌ Gagal upload file: ' + error.message;
  } else {
    status.textContent = '✅ File berhasil diupload';
    loadFiles(user);
  }
};
logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
};

    
  </script>
</body>
</html>
